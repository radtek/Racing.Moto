
@{
    ViewBag.Title = "首页";
}

<h1>ASP.NET SignalR Sample</h1>

<h2>实时推送</h2>
<div id="stockTable"></div>

<!--Script references. -->
<script src="/Scripts/jquery.signalR-2.2.1.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="/signalr/hubs"></script>
<script type="text/javascript">
    $(function () {

        var ticker = $.connection.pkTickerHub, // the generated client-side hub proxy
            up = '▲',
            down = '▼',
            $stockTable = $('#stockTable'),
            $stockTableBody = $stockTable.find('tbody'),
            rowTemplate = '<tr data-symbol="{Symbol}"><td>{Symbol}</td><td>{Price}</td><td>{DayOpen}</td><td>{Direction} {Change}</td><td>{PercentChange}</td></tr>';

        function formatStock(stock) {
            return $.extend(stock, {
                Price: stock.Price.toFixed(2),
                PercentChange: (stock.PercentChange * 100).toFixed(2) + '%',
                Direction: stock.Change === 0 ? '' : stock.Change >= 0 ? up : down
            });
        }

        function init() {
            ticker.server.getPkInfo().done(function (pkInfo) {
                //$stockTableBody.empty();
                //$.each(stocks, function () {
                //    var stock = formatStock(this);
                //    $stockTableBody.append(rowTemplate.supplant(stock));
                //});
                console.log(pkInfo);
                $stockTable.html(pkInfo);
            });
        }

        // Add a client-side hub method that the server will call
        ticker.client.updatePkInfo = function (pkInfo) {
            //var displayStock = formatStock(stock),
            //    $row = $(rowTemplate.supplant(displayStock));

            //$stockTableBody.find('tr[data-symbol=' + stock.Symbol + ']')
            //    .replaceWith($row);
            console.log(pkInfo);
            $stockTable.html(pkInfo);
        }

        // Start the connection
        $.connection.hub.start().done(init);

    });
</script>
